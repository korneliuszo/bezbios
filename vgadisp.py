#!/usr/bin/env python3

import tlay2_monitor

m=tlay2_monitor.tlay2_monitor()

m.inb(0x3DA)
m.outb(0x3C2,0xE3) #VGA_MISC_WRITE

seq = [0x03, 0x01, 0x08, 0x00, 0x06]
for i in range(len(seq)):
    m.outb(0x3C4,i) #VGA_SEQ_INDEX
    m.outb(0x3C5,seq[i]) #VGA_SEQ_DATA

m.outb(0x3D4, 0x03); #VGA_CRTC_INDEX
m.outb(0x3D5, 
        m.inb(0x3D5) | 0x80); #VGA_CRTC_DATA
m.outb(0x3D4, 0x11); #VGA_CRTC_INDEX
m.outb(0x3D5, 
        m.inb(0x3D5) & ~0x80); #VGA_CRTC_DATA

crtc = [
	0x5F, 0x4F, 0x50, 0x82, 0x54, 0x80, 0x0B, 0x3E,
	0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0xEA, 0x0C, 0xDF, 0x28, 0x00, 0xE7, 0x04, 0xE3,
	0xFF,]
for i in range(len(crtc)):
    m.outb(0x3D4,i) #VGA_CRTC_INDEX
    m.outb(0x3D5,crtc[i]) #VGA_CRTC_DATA

gc=[
    	0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x05, 0x0F,
	0xFF,]
for i in range(len(gc)):
    m.outb(0x3CE,i) #VGA_GC_INDEX
    m.outb(0x3CF,gc[i]) #VGA_GC_DATA
ac = [
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x14, 0x07,
	0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F,
	0x01, 0x00, 0x0F, 0x00, 0x00
        ]
for i in range(len(ac)):
    m.outb(0x3C0,i) #VGA_AC_INDEX
    m.outb(0x3C0,ac[i]) #VGA_AC_DATA
m.inb(0x3DA) #VGA_INSTAT_READ
m.outb(0x3C0,0x20) #VGA_AC_INDEX

def set_plane(p):
    p &= 3
    pmask = 1 << p
#/* set read plane */
    m.outb(0x3CE, 4) #VGA_GC_INDEX
    m.outb(0x3Cf, p) #VGA_GC_DATA
#/* set write plane */
    m.outb(0x3C4, 2) #VGA_SEQ_INDEX
    m.outb(0x3C5, pmask) #VGA_SEQ_DATA

from PIL import Image
import sys
im=Image.open(sys.argv[1]).convert("RGB")
im=im.resize((640,480))
pal_image= Image.new("P", (1,1))
pal_image.putpalette( (
    0,0,0,
    0,0,0xAA,
    0,0xAA,0,
    0,0xAA,0xAA,
    0xAA,0,0,
    0xAA,0,0XAA,
    0xAA,0x55,0,
    0xAA,0xAA,0xAA,
    0x55,0x55,0x55,
    0x55,0x55,0xff,
    0x55,0xff,0x55,
    0x55,0xff,0xff,
    0xff,0x55,0x55,
    0xff,0x55,0xff,
    0xff,0xff,0x00,
    0xff,0xff,0xff,
    ) + (0,0,0)*(256-16))

im=im.quantize(palette=pal_image)
from bitstring import BitArray

for plane in range(4):
    set_plane(plane)
    s=BitArray()
    for c in im.getdata():
        s += '0b1' if c&(1<<plane) else '0b0'
    m.putmem(0xA0000,s.tobytes())
